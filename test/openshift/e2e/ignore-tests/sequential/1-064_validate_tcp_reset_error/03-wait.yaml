apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
- script: |
    function wait_until_pods_running() {
      local namespace=$1
      echo -n "Waiting until all pods in namespace ${namespace} are up"
      for i in {1..150}; do  # timeout after 5 minutes
        local pods=$(oc get pods --no-headers -n ${namespace} 2>/dev/null)
        if [[ -n "${pods}" && -z $(echo "${pods}" | grep -vE 'Running|Completed') ]]; then
          if echo "${pods}" | awk '{ split($2, a, "/"); if (a[1] != a[2] || a[1] == 0) exit 1; }'; then
            echo -e "\nAll pods are up:\n${pods}"
            return 0
          fi
        fi
        echo -n "."
        sleep 2
      done
      echo -e "\n\nERROR: timeout waiting for pods to come up\n${pods}"
      return 1
    }
    
    wait_until_pods_running "test-1-27-custom"
